version: "2"

services:
  remark:
    # remove the next line in case you want to use this docker-compose separately
    # as otherwise it would complain for absence of Dockerfile
    build: .
    image: umputun/remark42:latest
    container_name: "remark42"
    hostname: "remark42"
    restart: always

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

    # uncomment to expose directly (no proxy)
    ports:
     - "8080:8080"

    environment:
      - REMARK_URL=http://localhost:8080
      - SECRET=12345
      - DEBUG=true
      - SITE=remark
      - AUTH_ANON=false
      - STORE_BOLT_PATH=/srv/var/db
      - BACKUP_PATH=/srv/var/backup
      # Config server email
      - SMTP_HOST=smtp.sendgrid.net
      - SMTP_PORT=465
      - SMTP_TLS=true
      - SMTP_USERNAME=apikey
      - SMTP_PASSWORD=####
      # Config auth with email
      - AUTH_EMAIL_SUBJ=remark42 confirmation
      - AUTH_EMAIL_CONTENT_TYPE=text/html
      - AUTH_EMAIL_ENABLE=true
      - AUTH_EMAIL_FROM=xuanthangnguyen2002@gmail.com
      # Enable it only for the initial comment import or for manual backups.
      # Do not leave the server running with the ADMIN_PASSWD set if you don't have an intention
      # to keep creating backups manually!
      # - ADMIN_PASSWD
    volumes:
      - ./var:/srv/var

  metabase-main:
    image: metabase/metabase:latest
    container_name: metabase-main
    hostname: metabase
    volumes:
    - /dev/urandom:/dev/random:ro
    ports:
      - 3002:3000
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: banking_db_4ebh
      MB_DB_PORT: 5432
      MB_DB_USER: banking_db_4ebh_user
      MB_DB_PASS: h8cggpsHBl0E6KRdCuOxNnuL7OkX4BgV
      MB_DB_HOST: dpg-co4o7bcf7o1s738upj3g-a.singapore-postgres.render.com
    networks:
      - metanet1
    healthcheck:
      test: curl --fail -I http://localhost:3000/api/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      
  postgres:
    image: postgres:latest
    container_name: postgres
    hostname: postgres
    environment:
      POSTGRES_USER: banking_db_4ebh_user
      POSTGRES_DB: banking_db_4ebh
      POSTGRES_PASSWORD: h8cggpsHBl0E6KRdCuOxNnuL7OkX4BgV
    networks:
      - metanet1
networks:
  metanet1:
    driver: bridge
